<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AICon — Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/main.css" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">AICon</a>
      <div class="d-flex align-items-center ms-auto">
        <span class="me-3 text-muted small">{{ phone }}</span>
        <form method="post" action="/logout" class="m-0">
          <button class="btn btn-outline-secondary btn-sm" type="submit">Logout</button>
        </form>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <h1 class="h3 mb-3">User Dashboard</h1>

    <div class="row g-3 mb-4">
      <div class="col-12 col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small">Minutes used</div>
                <div class="fs-4">{{ minutes_used }}</div>
              </div>
              <span class="badge bg-primary">Voice</span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small">Texts sent</div>
                <div class="fs-4">{{ texts_sent }}</div>
              </div>
              <span class="badge bg-success">SMS</span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-muted small">Current plan</div>
            <div class="fw-semibold">{{ current_plan or '—' }}</div>
            <div class="small text-muted">{{ billing_provider or '' }} {% if billing_since %} • since {{ billing_since.strftime('%Y-%m-%d') }}{% endif %}</div>
            <a class="btn btn-link btn-sm p-0 mt-2" href="/signup">Change plan</a>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12 col-lg-7">
        <div class="card h-100">
          <div class="card-header">Last 5 Interactions</div>
          <div class="list-group list-group-flush">
            {% for it in last5 %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge {% if it.input_type=='voice' %}bg-primary{% else %}bg-success{% endif %} me-2">{{ it.input_type|upper }}</span>
                    <span class="text-muted small">{{ it.created_at.strftime('%Y-%m-%d %H:%M') if it.created_at else '' }}</span>
                  </div>
                </div>
                <div class="mt-2">
                  <div class="small text-muted">You:</div>
                  <div>{{ (it.transcript or '')[:240] }}</div>
                </div>
                <div class="mt-2">
                  <div class="small text-muted">AI:</div>
                  <div>{{ (it.response or '')[:240] }}</div>
                </div>
              </div>
            {% else %}
              <div class="list-group-item text-muted">No interactions yet.</div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="card mb-4">
          <div class="card-header">Voice</div>
          <div class="card-body">
            <form action="/dashboard/preferences" method="post" enctype="multipart/form-data">
              <div class="mb-3">
                <label class="form-label">Select voice</label>
                <select name="voice" class="form-select">
                  <option value="">—</option>
                  {% for k,v in voice_keywords.items() %}
                    <option value="{{ k }}" {% if prefs.get('voice','').lower()==k %}selected{% endif %}>{{ k }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Upload for cloning (placeholder)</label>
                <input type="file" name="voice_clone" class="form-control" accept="audio/*" />
                <div class="form-text">Stores sample locally; cloning not executed here.</div>
              </div>
              <button class="btn btn-primary" type="submit">Save Voice Settings</button>
            </form>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">AI Personality</div>
          <div class="card-body">
            <form action="/dashboard/preferences" method="post">
              <div class="mb-3">
                <select name="persona" class="form-select">
                  {% set current = (prefs.get('persona','') or '').lower() %}
                  {% for opt in ['default','empathetic','legal','romantic','technical','friendly'] %}
                    <option value="{{ opt }}" {% if current==opt %}selected{% endif %}>{{ opt.title() }}</option>
                  {% endfor %}
                </select>
              </div>
              <button class="btn btn-primary" type="submit">Save Personality</button>
            </form>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">Security</div>
          <div class="card-body">
            <form action="/dashboard/passphrase" method="post" class="mb-3">
              <label class="form-label">Set passphrase</label>
              <div class="input-group">
                <input type="text" name="phrase" class="form-control" placeholder="Secret phrase" />
                <button class="btn btn-outline-secondary" type="submit">Save</button>
              </div>
            </form>
            <form action="/dashboard/security" method="post" enctype="multipart/form-data">
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" name="passphrase_required" id="passRequired" {% if (prefs.get('passphrase_required','off')=='on') %}checked{% endif %}>
                <label class="form-check-label" for="passRequired">Require passphrase to activate</label>
              </div>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" name="twofa" id="twofa" {% if (prefs.get('twofa','off')=='on') %}checked{% endif %}>
                <label class="form-check-label" for="twofa">Enable 2FA (placeholder)</label>
              </div>
              <div class="mb-3">
                <label class="form-label">Set voiceprint (upload sample)</label>
                <input type="file" name="voiceprint" class="form-control" accept="audio/*" />
              </div>
              <button class="btn btn-primary" type="submit">Save Security Settings</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-1">
      <div class="col-12 col-lg-7">
        <div class="card">
          <div class="card-header">Billing & Wallet</div>
          <div class="card-body">
            <form action="/dashboard/preferences" method="post">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">Crypto wallet address</label>
                  <input type="text" class="form-control" name="wallet" value="{{ prefs.get('wallet','') }}" />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Billing email</label>
                  <input type="email" class="form-control" name="billing_email" value="{{ prefs.get('billing_email','') }}" />
                </div>
              </div>
              <button class="btn btn-primary mt-3" type="submit">Save Billing Info</button>
              <a class="btn btn-link mt-3" href="/signup">Start/Change Subscription</a>
            </form>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="card h-100">
          <div class="card-header">Export</div>
          <div class="card-body">
            <a class="btn btn-outline-secondary me-2 mb-2" href="/dashboard/export/conversations.csv">Conversation Archive (CSV)</a>
            <a class="btn btn-outline-secondary mb-2" href="/dashboard/export/voice_history.json">Voice History (JSON)</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
