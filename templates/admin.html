<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AICon — Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/main.css" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin">AICon Admin</a>
      <form method="post" action="/admin/logout" class="ms-auto">
        <button class="btn btn-outline-light btn-sm" type="submit">Logout</button>
      </form>
    </div>
  </nav>

  <main class="container my-4">
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Users</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#plans" type="button" role="tab">Plans</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">Analytics</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#affiliates" type="button" role="tab">Affiliates</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#payouts" type="button" role="tab">Payout Queue</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">Logs</button></li>
    </ul>

    <div class="tab-content pt-3">
      <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="d-flex mb-2 gap-2">
          <input class="form-control" id="userSearch" placeholder="Search users by phone or name" />
          <button class="btn btn-secondary" onclick="loadUsers()">Search</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>Phone</th><th>Name</th><th>Affiliate Code</th><th>Suspended</th><th>Actions</th></tr></thead>
            <tbody id="userRows"></tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane fade" id="plans" role="tabpanel">
        <div class="d-flex gap-2 mb-2">
          <input class="form-control" id="planName" placeholder="Name" style="max-width: 12rem;" />
          <input class="form-control" id="planPriceId" placeholder="Stripe price id" />
          <input class="form-control" id="planCoupon" placeholder="Coupon (optional)" style="max-width: 12rem;" />
          <input class="form-control" id="planDesc" placeholder="Description" />
          <button class="btn btn-primary" onclick="createPlan()">Add Plan</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>Name</th><th>Price ID</th><th>Coupon</th><th>Active</th><th>Description</th><th></th></tr></thead>
            <tbody id="planRows"></tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane fade" id="analytics" role="tabpanel">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card"><div class="card-header">Usage (last 30 days)</div><div class="card-body"><canvas id="usageChart"></canvas></div></div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card"><div class="card-header">Subscriptions</div><div class="card-body"><canvas id="subsChart"></canvas></div></div>
          </div>
          <div class="col-12">
            <div class="card"><div class="card-header">Referrals</div><div class="card-body"><canvas id="refsChart"></canvas></div></div>
          </div>
          <div class="col-12">
            <div class="card"><div class="card-header">Usage by Hour</div><div class="card-body"><canvas id="hourChart"></canvas></div></div>
          </div>
          <div class="col-12">
            <div class="card"><div class="card-header">Usage Heatmap (Mon–Sun x 24h)</div>
              <div class="card-body">
                <div id="heatmap" class="d-grid" style="grid-template-columns: repeat(24, minmax(14px, 1fr)); gap:2px"></div>
                <div class="text-muted small mt-2">Rows: Mon (top) to Sun (bottom). Darker = more usage.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="affiliates" role="tabpanel">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>Code</th><th>Commission (USD)</th></tr></thead>
            <tbody id="topAffRows"></tbody>
          </table>
        </div>
        <h6 class="mt-3">Referral Logs</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>Affiliate</th><th>Referred</th><th>Amount</th><th>Commission</th><th>When</th></tr></thead>
            <tbody id="refRows"></tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane fade" id="payouts" role="tabpanel">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>ID</th><th>Affiliate</th><th>Amount</th><th>Wallet</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="payoutRows"></tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane fade" id="logs" role="tabpanel">
        <div class="d-flex mb-2 gap-2">
          <input class="form-control" id="logSearch" placeholder="Search text or phone" />
          <button class="btn btn-secondary" onclick="loadLogs()">Search</button>
        </div>
        <div class="list-group" id="logList"></div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    async function loadUsers() {
      const q = document.getElementById('userSearch').value;
      const res = await fetch('/admin/users?q=' + encodeURIComponent(q));
      const data = await res.json();
      const tbody = document.getElementById('userRows');
      tbody.innerHTML = '';
      data.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.phone}</td>
          <td>${u.name || ''}</td>
          <td><input class="form-control form-control-sm" value="${u.affiliate_code||''}" onchange="setAffiliate('${u.phone}', this.value)"/></td>
          <td>${u.suspended ? '<span class="badge bg-danger">Yes</span>' : '<span class="badge bg-success">No</span>'}</td>
          <td>
            <button class="btn btn-sm ${u.suspended ? 'btn-success' : 'btn-warning'}" onclick="toggleSuspend('${u.phone}', ${u.suspended})">${u.suspended ? 'Unsuspend' : 'Suspend'}</button>
            <div class="input-group input-group-sm mt-1" style="max-width: 16rem;">
              <select class="form-select" id="plan_${u.phone}">
                <option value="basic">Basic</option>
                <option value="pro">Pro</option>
                <option value="custom">Custom</option>
              </select>
              <button class="btn btn-outline-primary" onclick="upgradePlan('${u.phone}')">Set Plan</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    async function toggleSuspend(phone, suspended) {
      await fetch('/admin/users/update', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({phone, action: suspended?'unsuspend':'suspend'})});
      loadUsers();
    }
    async function setAffiliate(phone, code) {
      await fetch('/admin/users/update', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({phone, action:'set_affiliate_code', code})});
    }
    async function upgradePlan(phone) {
      const sel = document.getElementById('plan_' + phone);
      await fetch('/admin/users/update', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({phone, action:'upgrade_plan', plan: sel.value})});
    }

    async function loadPlans() {
      const res = await fetch('/admin/plans');
      const data = await res.json();
      const tbody = document.getElementById('planRows');
      tbody.innerHTML = '';
      data.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="form-control form-control-sm" value="${p.name}" onchange="updatePlan(${p.id}, {name:this.value})"/></td>
          <td><input class="form-control form-control-sm" value="${p.price_id||''}" onchange="updatePlan(${p.id}, {price_id:this.value})"/></td>
          <td><input class="form-control form-control-sm" value="${p.discount_coupon||''}" onchange="updatePlan(${p.id}, {discount_coupon:this.value})"/></td>
          <td><input class="form-check-input" type="checkbox" ${p.active==='true'?'checked':''} onchange="updatePlan(${p.id}, {active:this.checked})"/></td>
          <td><input class="form-control form-control-sm" value="${p.description||''}" onchange="updatePlan(${p.id}, {description:this.value})"/></td>
          <td><button class="btn btn-sm btn-outline-danger" onclick="deletePlan(${p.id})">Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }
    async function createPlan() {
      const name = document.getElementById('planName').value;
      const price_id = document.getElementById('planPriceId').value;
      const discount_coupon = document.getElementById('planCoupon').value;
      const description = document.getElementById('planDesc').value;
      await fetch('/admin/plans', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, price_id, discount_coupon, description})});
      document.getElementById('planName').value = '';
      document.getElementById('planPriceId').value = '';
      document.getElementById('planCoupon').value = '';
      document.getElementById('planDesc').value = '';
      loadPlans();
    }
    async function updatePlan(id, patch) {
      await fetch('/admin/plans/update', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(Object.assign({id}, patch))});
    }
    async function deletePlan(id) {
      await fetch('/admin/plans/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
      loadPlans();
    }

    async function loadAnalytics() {
      const res = await fetch('/admin/analytics/summary?days=30');
      const data = await res.json();
      renderCharts(data);
    }
    function renderCharts(d) {
      const uctx = document.getElementById('usageChart');
      new Chart(uctx, {type:'line', data:{labels:d.usage.labels, datasets:[{label:'SMS', data:d.usage.sms, borderColor:'#198754'},{label:'Voice', data:d.usage.voice, borderColor:'#0d6efd'}]}});
      const sctx = document.getElementById('subsChart');
      new Chart(sctx, {type:'bar', data:{labels:d.subscriptions.labels, datasets:[{label:'Subs', data:d.subscriptions.count, backgroundColor:'#6610f2'}]}});
      const rctx = document.getElementById('refsChart');
      new Chart(rctx, {type:'bar', data:{labels:d.referrals.labels, datasets:[{label:'Referrals', data:d.referrals.count, backgroundColor:'#fd7e14'}]}});
      const hctx = document.getElementById('hourChart');
      new Chart(hctx, {type:'bar', data:{labels:[...Array(24).keys()].map(h=>h+':00'), datasets:[{label:'Msgs by Hour', data:d.hour_hist, backgroundColor:'#20c997'}]}});
      const heat = document.getElementById('heatmap');
      heat.innerHTML='';
      // Normalize intensity
      let maxv = 0; d.heatmap.forEach(row => row.forEach(v => { if (v>maxv) maxv=v; }));
      const rows = d.heatmap;
      rows.forEach(row => {
        row.forEach(v => {
          const cell = document.createElement('div');
          const intensity = maxv? Math.round((v/maxv)*100) : 0;
          cell.style.height = '16px';
          cell.style.background = `rgba(13,110,253, ${0.1 + 0.9*(intensity/100)})`;
          cell.title = v + ' msgs';
          heat.appendChild(cell);
        });
      });
    }

    async function loadAffiliates() {
      const resTop = await fetch('/admin/affiliates/top');
      const top = await resTop.json();
      const tbody = document.getElementById('topAffRows');
      tbody.innerHTML='';
      top.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.code||r.affiliate_id}</td><td>$${(r.commission_cents/100).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      const resRefs = await fetch('/admin/referrals');
      const refs = await resRefs.json();
      const refRows = document.getElementById('refRows');
      refRows.innerHTML='';
      refs.forEach(x=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${x.affiliate_id}</td><td>${x.referred_phone}</td><td>$${(x.amount_cents/100).toFixed(2)}</td><td>$${(x.commission_cents/100).toFixed(2)}</td><td>${x.created_at}</td>`;
        refRows.appendChild(tr);
      });
    }

    async function loadPayouts() {
      const res = await fetch('/admin/payouts');
      const data = await res.json();
      const tbody = document.getElementById('payoutRows');
      tbody.innerHTML='';
      data.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${p.id}</td><td>${p.affiliate_id}</td><td>$${(p.amount_cents/100).toFixed(2)}</td><td>${p.wallet_address||''}</td><td>${p.status}</td><td>
          <button class="btn btn-sm btn-outline-success me-1" onclick="setPayout(${p.id}, 'approved')">Approve</button>
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="setPayout(${p.id}, 'paid')">Mark Paid</button>
          <button class="btn btn-sm btn-outline-danger" onclick="setPayout(${p.id}, 'rejected')">Reject</button>
        </td>`;
        tbody.appendChild(tr);
      });
    }
    async function setPayout(id, status) {
      await fetch('/admin/payouts/update', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, status})});
      loadPayouts();
    }

    async function loadLogs() {
      const q = document.getElementById('logSearch').value;
      const res = await fetch('/admin/interactions?q='+encodeURIComponent(q)+'&limit=100');
      const data = await res.json();
      const list = document.getElementById('logList');
      list.innerHTML='';
      const flaggedTerms = ['abuse','violate','illegal','self-harm','suicide','hate'];
      data.forEach(i=>{
        const flagged = (i.transcript||'' + ' ' + (i.response||'')).toLowerCase();
        const isFlagged = flaggedTerms.some(t=> flagged.includes(t));
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `<div class="d-flex justify-content-between"><div><span class="badge ${i.input_type==='voice'?'bg-primary':'bg-success'} me-2">${i.input_type.toUpperCase()}</span>
          <span class="text-muted small">${i.created_at}</span> • <span class="text-muted small">${i.user_id}</span></div>
          ${isFlagged?'<span class="badge bg-danger">Flagged</span>':''}</div>
          <div class="mt-2"><div class="small text-muted">User</div><div>${(i.transcript||'').slice(0,400)}</div></div>
          <div class="mt-2"><div class="small text-muted">AI</div><div>${(i.response||'').slice(0,400)}</div></div>`;
        list.appendChild(item);
      });
    }

    // Initial loads
    loadUsers();
    loadPlans();
    loadAnalytics();
    loadAffiliates();
    loadPayouts();
    loadLogs();
  </script>
</body>
</html>
