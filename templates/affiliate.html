<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AICon — Affiliate Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/main.css" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">AICon</a>
      <div class="ms-auto">
        <a class="btn btn-outline-secondary btn-sm" href="/dashboard">Dashboard</a>
      </div>
    </div>
  </nav>
  <main class="container my-4">
    <h1 class="h4 mb-3">Affiliate Dashboard</h1>

    {% if not code %}
      <div class="alert alert-info">You don't have an affiliate code yet.</div>
      <form method="post" action="/affiliate/generate">
        <button class="btn btn-primary">Generate My Referral Code</button>
      </form>
    {% else %}
      <div class="row g-3 mb-4">
        <div class="col-12 col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <div class="small text-muted">Your code</div>
              <div class="display-6">{{ code }}</div>
              <div class="mt-2">
                <div class="small text-muted">Link</div>
                <div class="input-group">
                  <input class="form-control" value="{{ link }}" readonly>
                  <a class="btn btn-outline-secondary" href="{{ link }}" target="_blank">Open</a>
                </div>
              </div>
              <div class="mt-3">
                <div id="qrcode"></div>
                <div class="form-text">Share or print QR for signups.</div>
                <a class="btn btn-link p-0 mt-2" href="/affiliate/flyer" target="_blank">Printable flyer</a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <div class="row text-center">
                <div class="col-4">
                  <div class="small text-muted">Today</div>
                  <div class="fs-4">${{ (earnings_day/100)|round(2) }}</div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">Week</div>
                  <div class="fs-4">${{ (earnings_week/100)|round(2) }}</div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">Total</div>
                  <div class="fs-4">${{ (earnings_total/100)|round(2) }}</div>
                </div>
              </div>
              <div class="mt-3">
                <div class="small text-muted">Signups total</div>
                <div class="fs-5">{{ signups_total }}</div>
              </div>
              <div class="mt-3">
                <form method="post" action="/affiliate/withdraw" class="row g-2 align-items-end">
                  <div class="col-auto">
                    <label class="form-label">Available</label>
                    <div class="fs-5">${{ (available_cents/100)|round(2) }}</div>
                  </div>
                  <div class="col-auto">
                    <label class="form-label">Amount (USD)</label>
                    <input type="number" step="0.01" min="{{ (min_withdraw_cents/100) }}" max="{{ (available_cents/100) }}" name="amount" class="form-control" placeholder="{{ (available_cents/100)|round(2) }}">
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-primary" {% if available_cents < min_withdraw_cents %}disabled{% endif %}>Request Withdrawal</button>
                  </div>
                  {% if available_cents < min_withdraw_cents %}
                    <div class="form-text">Minimum balance ${{ (min_withdraw_cents/100)|round(2) }} to withdraw.</div>
                  {% endif %}
                </form>
                <div class="mt-2">
                  <a class="btn btn-link p-0" href="/affiliate/earnings.csv">Export earnings (CSV)</a>
                </div>
                <div class="alert alert-warning mt-3 py-2">Crypto markets carry risk. Values may fluctuate. Invest at your own pace.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if tier %}
      <div class="row g-3 mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">Your Tier & Milestones</div>
            <div class="card-body row">
              <div class="col-md-4">
                <div class="small text-muted">Current Commission</div>
                <div class="fs-4">{{ (tier.percent_bps/100)|round(2) }}%</div>
                <div class="small text-muted">Residual Window</div>
                <div class="fs-6">{{ tier.months }} months</div>
              </div>
              <div class="col-md-4">
                <div class="small text-muted">Signups</div>
                <div class="fs-5">Total: {{ tier.metrics.total_signups }}</div>
                <div class="fs-6 text-muted">Last 30 days: {{ tier.metrics.velocity_30d }}</div>
              </div>
              <div class="col-md-4">
                {% if tier.next_tier %}
                  <div class="small text-muted">Next Tier Target</div>
                  <div class="fs-6">Reach {{ tier.next_tier.min_signups }} total or {{ tier.next_tier.min_velocity_30d }} in 30 days</div>
                  <div class="small">Then earn {{ (tier.next_tier.percent_bps/100)|round(2) }}% for {{ tier.next_tier.months }} months.</div>
                {% else %}
                  <div class="small text-muted">Top Tier Achieved</div>
                  <div class="fs-6">Keep momentum to maintain benefits.</div>
                {% endif %}
              </div>
            </div>
            <div class="card-footer small text-muted">
              Program rules: no spam, fraud, or self‑referrals. Commissions may be reversed for refunds or policy violations. Residuals apply to active subscriptions within your tier window.
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="row g-4">
        <div class="col-12 col-lg-7">
          <div class="card">
            <div class="card-header">Recent Signups</div>
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead><tr><th>Phone</th><th>Name</th><th>Facility</th><th>Joined</th></tr></thead>
                <tbody>
                  {% for u in recent_signups %}
                    <tr><td>{{ u.phone }}</td><td>{{ u.name or '' }}</td><td>{{ u.facility_code or '' }}</td><td>{{ u.created_at.strftime('%Y-%m-%d') if u.created_at else '' }}</td></tr>
                  {% else %}
                    <tr><td colspan="4" class="text-muted">No signups yet.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-5">
          <div class="card h-100">
            <div class="card-header">Payout & Partner Settings</div>
            <div class="card-body">
              <form method="post" action="/affiliate/prefs" class="vstack gap-2">
                <div class="mb-2">
                  <span class="badge {% if voice_verified %}bg-success{% else %}bg-warning{% endif %}">
                    {% if voice_verified %}Voiceprint Verified{% else %}Voiceprint Not Set{% endif %}
                  </span>
                </div>
                <div>
                  <label class="form-label">Payout Method</label>
                  <select class="form-select" name="payout_method">
                    {% set method = (prefs.get('payout_method','') or '').lower() %}
                    {% for m in ['commissary','paypal','crypto'] %}
                      <option value="{{ m }}" {% if method==m %}selected{% endif %}>{{ m.title() }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="form-label">PayPal Email</label>
                  <input class="form-control" name="paypal_email" type="email" value="{{ prefs.get('paypal_email','') }}"/>
                </div>
                <div>
                  <label class="form-label">Crypto Wallet Address</label>
                  <input class="form-control" name="crypto_wallet" value="{{ prefs.get('crypto_wallet','') }}"/>
                </div>
                <div>
                  <label class="form-label">Proxy Name</label>
                  <input class="form-control" name="proxy_name" value="{{ prefs.get('proxy_name','') }}"/>
                </div>
                <div>
                  <label class="form-label">Proxy Email</label>
                  <input class="form-control" name="proxy_email" type="email" value="{{ prefs.get('proxy_email','') }}"/>
                </div>
                <div>
                  <label class="form-label">Proxy Phone</label>
                  <input class="form-control" name="proxy_phone" value="{{ prefs.get('proxy_phone','') }}"/>
                </div>
                <div>
                  <label class="form-label">Invest Residuals</label>
                  {% set invest = (prefs.get('invest_destination','none') or 'none') %}
                  <select class="form-select" name="invest_destination">
                    {% for m in ['none','robinhood','acorns'] %}
                      <option value="{{ m }}" {% if invest==m %}selected{% endif %}>{{ m.title() }}</option>
                    {% endfor %}
                  </select>
                  <div class="form-text">We may route a portion of future earnings to your selected platform.</div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" name="vault_mode" id="vault_mode" {% if (prefs.get('vault_mode','off')=='on') %}checked{% endif %}>
                  <label class="form-check-label" for="vault_mode">Vault Mode (lock funds until release)</label>
                </div>
                <div>
                  <label class="form-label">Release Date (YYYY-MM-DD)</label>
                  <input class="form-control" name="vault_release" placeholder="2025-12-31" value="{{ prefs.get('vault_release','') }}" />
                </div>
                <div>
                  <button class="btn btn-outline-primary">Save Preferences</button>
                </div>
              </form>
              <hr/>
              <form method="post" action="/affiliate/set_parent" class="vstack gap-2">
                <div>
                  <label class="form-label">Partner Upline Code (optional)</label>
                  <input class="form-control" name="parent_code" value="{{ parent_code or '' }}" placeholder="Enter sponsor's affiliate code" />
                  <div class="form-text">Your sponsor may earn a 1% override from your referrals.</div>
                </div>
                <div>
                  <button class="btn btn-outline-secondary">Save Upline</button>
                </div>
                <div class="mt-2">
                  <a class="btn btn-sm btn-outline-info" href="/affiliate/welcome-kit" target="_blank">Printable Welcome Kit</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="mt-4">
      <h2 class="h5">Leaderboard</h2>
      <div class="row g-2 align-items-end">
        <div class="col-auto">
          <label class="form-label">Facility Code</label>
          <input id="facilityCode" class="form-control" placeholder="e.g. FAC123" />
        </div>
        <div class="col-auto"><button class="btn btn-secondary" onclick="loadLeaderboard()">Load</button></div>
      </div>
      <div class="table-responsive mt-2">
        <table class="table table-sm mb-0">
          <thead><tr><th>Affiliate Code</th><th>Earnings</th></tr></thead>
          <tbody id="lbRows"></tbody>
        </table>
      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    const link = {{ (link or 'null')|tojson }};
    if (link) {
      const container = document.getElementById('qrcode');
      const canvas = document.createElement('canvas');
      container.appendChild(canvas);
      QRCode.toCanvas(canvas, link, {width: 180});
    }
    async function loadLeaderboard() {
      const f = document.getElementById('facilityCode').value;
      const res = await fetch('/affiliates/leaderboard' + (f? ('?facility=' + encodeURIComponent(f)) : ''));
      const data = await res.json();
      const tbody = document.getElementById('lbRows');
      tbody.innerHTML='';
      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.code||r.affiliate_id}</td><td>$${(r.commission_cents/100).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }
    loadLeaderboard();
  </script>
</body>
</html>
